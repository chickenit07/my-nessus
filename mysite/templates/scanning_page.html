{% extends 'base.html' %} {% block content %}
<div class="container">
  <h1>Scanning Page</h1>
  <form id="scan-form" method="POST">
    <div class="row">
      {% csrf_token %} {% for field in form %}
      <div class="form-group col-8">
        <label class="col-12">{{ field.label }}</label>
        {{ field }}
      </div>
      {% endfor %}
    </div>
    <input type="submit" class="btn btn-primary" value="Start Scan" />
  </form>
</div>
<br />
<div class="container-fluid">
  <table class="table table-striped table-sm" id="recent-scan">
    <thead>
      <tr>
        {% comment %} <th>Id</th> {% endcomment %}
        <th>Scan name</th>
        <th>Host</th>
        <th>Date</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for scan in scans %}
      <tr>
        <td>{{scan.scan_name}}</td>
        <td>{{scan.host}}</td>
        <td>{{scan.scan_date | date:"Y-m-d"}}</td>
        <td>{{scan.scan_status}}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock content %} {% block javascript %}
<script>
  /*
        On submiting the form, send the POST ajax
        request to server and after successfull submission
        display the object.
    */
  $(document).ready(function() {
    $("#scan-form").submit(function (e) {
      // preventing from page reload and default actions
      e.preventDefault();
      // serialize the data for sending the form data.
      var serializedData = $(this).serialize();
      // make POST ajax call
      $.ajax({
        type: "POST",
        url: "{% url 'ajax_scan' %}",
        data: serializedData,
        dataType: 'json',
        success: function (response) {
          // on successfull creating object
          // 1. clear the form.
          $("#scan-form").trigger("reset");
          // 2. focus to scan name input
          $("#scan_name").focus();

          // display the newly scan to table.
          var instance = JSON.parse(response["instance"]);

          var scans = instance[0]["fields"];

          $("#recent-scan tbody").prepend(
              `<tr> 
                {% comment %} <td>${scans["scan_id"] || ""}</td> {% endcomment %}
                <td>${scans["scan_name"] || ""}</td>
                <td>${scans["host"] || ""}</td>
                <td>${scans["scan_date"] || ""}</td>
                <td>${scans["scan_status"] || ""}</td>
                </tr>`);
        },
        error: function (response) {
          // alert the error if any error occured
          alert(response["responseJSON"]["error"]);
        },
      });
    });
  });
</script>
{% endblock javascript %}
